<!-- Main Content Area -->
<div class="flex-1 flex flex-col overflow-hidden">
   <div class="max-w-6xl mx-auto px-4 py-8">
  <!-- Page Header -->
  <div class="mb-6 sm:mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
      <div class="flex-1">
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-800 mb-2">ðŸŽ§ Music Therapy</h1>
        <p class="text-gray-600 text-sm sm:text-base lg:text-lg leading-relaxed">
          Browse calming playlists and therapeutic sounds designed to support
          your mental wellbeing
        </p>
      </div>
      <!-- Now Playing Indicator -->
      <div id="now-playing" class="hidden lg:block"></div>
    </div>
    <!-- Player Status Display -->
    <div id="player-status" class="mt-4">
      <% if (!hasSpotifyToken) { %>
      <div class="p-3 sm:p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="flex-1">
            <p class="text-blue-800 font-medium flex items-center text-sm sm:text-base">
              <i class="fas fa-music mr-2"></i> Enhanced Music Experience
            </p>
            <p class="text-xs sm:text-sm text-blue-600 mt-1">
              Listen to available 30s previews. Connect Spotify for personalized recommendations and seamless full-track access in the app.
            </p>
          </div>
          <a
            href="/spotify/login"
            class="px-4 sm:px-6 py-2 sm:py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200 font-medium shadow-md hover:shadow-lg flex items-center justify-center text-sm sm:text-base w-full sm:w-auto"
          >
            <i class="fab fa-spotify mr-2"></i> Connect Spotify
          </a>
        </div>
      </div>
      <% } else { %>
      <div class="p-3 sm:p-4 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="flex-1">
            <p class="text-green-800 font-medium flex items-center text-sm sm:text-base">
              <i class="fas fa-check-circle mr-2"></i> Spotify Connected
            </p>
            <p class="text-xs sm:text-sm text-green-600 mt-1">
              Enjoy available previews and open full tracks in Spotify. Note: Not all songs have 30s previews due to Spotify's API.
            </p>
          </div>
          <div class="flex space-x-2">
            <a
              href="/spotify/logout"
              class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm whitespace-nowrap"
            >
              <i class="fas fa-unlink mr-1"></i> Disconnect
            </a>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  </div>
  <!-- Categories Grid -->
  <div class="mb-8">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6">
      Therapy Categories
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
      <% categories.forEach((cat, index) => { %>
      <div
        class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group transform hover:-translate-y-1"
      >
        <!-- Category Image -->
        <div class="relative overflow-hidden">
          <img
            src="<%= cat.cover_url %>"
            alt="<%= cat.title %>"
            class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
          />
          <div
            class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"
          ></div>
        </div>
        <!-- Category Content -->
        <div class="p-6">
          <h3
            class="text-xl font-bold mb-2 text-gray-800 group-hover:text-primary transition-colors"
          >
            <%= cat.title %>
          </h3>
          <p class="text-gray-600 mb-4 text-sm leading-relaxed">
            <%= cat.description %>
          </p>
          <!-- Category Stats -->
          <div
            class="flex items-center justify-between text-xs text-gray-500 mb-4"
          >
            <span class="flex items-center">
              <i class="fas fa-music mr-1"></i> <%= (allSongs[cat.id] ||
              []).length %> tracks
            </span>
            <span class="flex items-center">
              <i class="fas fa-clock mr-1"></i> ~<%= Math.floor(Math.random() *
              30 + 15) %> min
            </span>
          </div>
          <!-- Action Button -->
          <button
            class="w-full px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all duration-200 font-medium category-btn group-hover:shadow-md flex items-center justify-center"
            data-category-id="<%= cat.id %>"
          >
            <i class="fas fa-play mr-2"></i> View Songs
          </button>
        </div>
      </div>
      <% }) %>
    </div>
  </div>
  <!-- Usage Instructions -->
  <div class="mb-8">
    <div
      class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-xl p-6"
    >
      <h3 class="text-xl font-semibold text-blue-900 mb-4 flex items-center">
        <i class="fas fa-info-circle mr-2"></i> How to Use Music Therapy
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Without Spotify -->
        <div class="bg-white/50 rounded-lg p-4">
          <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
            <i class="fas fa-headphones mr-2"></i> Without Spotify
          </h4>
          <ul class="space-y-2 text-sm text-blue-700">
            <li class="flex items-start">
              <i class="fas fa-check-circle mr-2 mt-0.5 text-green-600"></i>
              Listen to 30-second previews of all tracks
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mr-2 mt-0.5 text-green-600"></i> Use
              built-in audio controls for easy playback
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mr-2 mt-0.5 text-green-600"></i>
              Browse and discover new therapeutic music
            </li>
          </ul>
        </div>
        <!-- With Spotify -->
        <div class="bg-white/50 rounded-lg p-4">
          <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
            <i class="fab fa-spotify mr-2"></i> With Spotify Premium
          </h4>
          <ul class="space-y-2 text-sm text-blue-700">
            <li class="flex items-start">
              <i class="fas fa-check-circle mr-2 mt-0.5 text-green-600"></i>
              Play full tracks without interruption
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mr-2 mt-0.5 text-green-600"></i>
              Control playback remotely across devices
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mr-2 mt-0.5 text-green-600"></i>
              Create seamless, therapeutic listening experiences
            </li>
          </ul>
        </div>
      </div>
      <!-- Tips Section -->
      <div class="mt-6 p-4 bg-yellow-100 border border-yellow-300 rounded-lg">
        <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
          <i class="fas fa-lightbulb mr-2"></i> Therapeutic Listening Tips
        </h4>
        <div
          class="text-sm text-yellow-700 grid grid-cols-1 md:grid-cols-2 gap-3"
        >
          <div>â€¢ Find a quiet, comfortable space</div>
          <div>â€¢ Use quality headphones if possible</div>
          <div>â€¢ Set aside 15-30 minutes for sessions</div>
          <div>â€¢ Focus on your breathing while listening</div>
        </div>
      </div>
    </div>
  </div>

<!-- Enhanced Modal -->
<div
  id="categoryModal"
  class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4"
>
  <div
    class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden mx-4"
  >
    <!-- Modal Header -->
    <div
      class="flex justify-between items-center p-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white"
    >
      <div>
        <h2 id="modalTitle" class="text-2xl font-bold">Category</h2>
        <p id="modalSubtitle" class="text-blue-100 text-sm mt-1">
          Therapeutic music collection
        </p>
      </div>
      <button
        id="closeModalBtn"
        class="text-white hover:text-gray-200 p-2 rounded-full hover:bg-white/10 transition-colors"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <!-- Modal Instructions -->
    <div
      id="modalInstructions"
      class="mx-6 mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg"
    >
      <div class="flex items-start">
        <i class="fas fa-lightbulb text-yellow-600 mr-2 mt-0.5"></i>
        <div class="text-sm text-yellow-800">
          <strong>Listening Guide:</strong>
          <span id="instructionText"
            >Click play buttons for full tracks (Spotify Premium) or use audio
            controls for 30-second previews.</span
          >
        </div>
      </div>
    </div>
    <!-- Modal Content -->
    <div class="p-6 max-h-[60vh] overflow-y-auto">
      <div id="modalSongs" class="space-y-3">
        <!-- Songs will be injected here by music.js -->
      </div>
      <!-- Empty State -->
      <div id="modalEmptyState" class="hidden text-center py-12">
        <i class="fas fa-music text-gray-300 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-600 mb-2">
          No Songs Available
        </h3>
        <p class="text-gray-500">
          This category doesn't have any songs yet. Please try another category
          or check back later.
        </p>
      </div>
    </div>
    <!-- Modal Footer -->
    <div
      class="px-6 py-4 bg-gray-50 border-t flex justify-between items-center"
    >
      <div class="text-sm text-gray-600">
        <i class="fas fa-heart text-red-500 mr-1"></i> Music therapy can help
        reduce stress and anxiety
      </div>
      <button
        id="closeModalBtn2"
        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
      >
        Close
      </button>
    </div>
  </div>
</div>
<!-- Temporary Message Container -->
<div id="temp-message" class="hidden"></div>
<!-- Data Storage (Hidden) -->
<div id="categories-data" style="display: none">
  <%- JSON.stringify(categories || []) %>
</div>
<div id="songs-data" style="display: none">
  <%- JSON.stringify(allSongs || {}) %>
</div>
<script>
// Enhanced music.js integration with proper category tracking
window.SPOTIFY_TOKEN = '<%= spotifyToken || "" %>';

// Make trackCategoryUsage globally available
window.trackCategoryUsage = async function(category, action = 'play') {
    try {
        console.log(`Tracking music category: ${category} (${action})`);
        
        const response = await fetch('/music/track-category', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                category: category,
                action: action 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log(`Category ${category} tracked successfully. Play count: ${data.playCount}`);
        } else {
            console.warn('Failed to track category:', data.message);
        }
    } catch (error) {
        console.error('Error tracking category:', error);
    }
};

// Make openInSpotify globally available with tracking
window.openInSpotify = function(openUrl, categoryId) {
  if (!openUrl || openUrl === "#") {
    console.warn("No Spotify URL available");
    return;
  }

  console.log("Opening track in Spotify:", openUrl, "Category:", categoryId);
  
  // Track the category usage when user opens Spotify
  if (categoryId) {
    trackCategoryUsage(categoryId, 'spotify_open');
  }
  
  window.open(openUrl, "_blank");
  
  // Show success message
  const messageDiv = document.getElementById("temp-message");
  if (messageDiv) {
    messageDiv.className = "fixed top-4 right-4 p-3 border-l-4 rounded shadow-lg z-50 bg-green-100 border-green-500 text-green-700";
    messageDiv.textContent = "Opening full track in Spotify...";
    messageDiv.classList.remove("hidden");
    
    setTimeout(() => {
      messageDiv.classList.add("hidden");
    }, 3000);
  }
};

console.log("Music tracking functions loaded");
</script>